<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-chubby/css/uicons-regular-chubby.css'>
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/3.0.0/uicons-solid-rounded/css/uicons-solid-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/3.0.0/uicons-solid-chubby/css/uicons-solid-chubby.css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>User Dashboard</title>
    <link rel="stylesheet" href="../../src/css/user-dashboard.css">


</head>

<body>
    <div class="container">

        <button class="hamburger">
            <i class="fa-solid fa-bars"></i>
        </button>

        <aside class="sidebar">
            <div class="logo">
                <img src="../../src/images/Adobe Express - file.png">
                Indhan
            </div>
            <nav>
                <ul>
                    <li class="active" data-target="dashboard">
                        <i class="fi fi-sr-objects-column sidebar-icons"></i>
                        <span>Dashboard</span>
                    </li>
                    <li data-target="user-profile"><i class="fa-solid fa-user fa-user sidebar-icons"></i><span>User
                            Profile</span>
                    </li>
                    <!-- <li data-target=""><i class="fi fi-rc-arrow-progress sidebar-icons"></i>Request</li> -->
                    <li data-target="book-cylinder"><i class="fi fi-sr-medicine sidebar-icons"></i><span>Book
                            Cylinder</span>
                    </li>
                    <li data-target="booking-history"><i class="fa-solid fa-book sidebar-icons"></i><span>Booking
                            History</span>
                    </li>
                    <!-- <li data-target=""> <i class="fa-solid fa-flag sidebar-icons"></i> Reports</li> -->
                </ul>
            </nav>
            <div data-target="user-setting" class="settings">
                <i class="fa-solid fa-gear sidebar-icons"></i>
                Settings
            </div>
            <div class="logout" onclick="logoutUser()">
                <i class="fi fi-sc-leave logout-icon"></i>
                Logout
            </div>
        </aside>

        <main class="main">
            <!-- Header -->
            <header class="topbar">
                <div class="search">
                    <input type="text" id="searchInput" placeholder="Search...">
                    <button onclick="searchInPage()">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                    <div id="searchMessage" style="color: red; margin-top: 5px;"></div>
                </div>
                <div class="actions">
                    <div class="notification">üîî<span>0</span></div>
                    <div class="avatar">
                        <img src="../../src/images/profile-user (1).png">
                    </div>
                    <!-- avatar pop up -->
                    <div class="profile-popup" id="profilePopup">
                        <div class="profile-head">
                            <img src="../../src/images/profile-user.png" alt="Avatar" class="profile-avatar" />
                            <div class="status-indicator"></div>
                        </div>
                        <!-- replace <div id="user-role" class="profile-badge"></div> to the below line to fetch it from the database -->
                        <div class="profile-badge">Customer</div>
                        <div id="user-name" class="profile-name"></div>
                        <div class="profile-meta">
                            <!-- <span>@john</span>
                            <span>¬∑</span> -->
                            <span id="joined-date">Joined Apr 2019</span>
                            <span>¬∑</span>
                            <span class="active">Active now</span>
                        </div>
                    </div>
                </div>
            </header>
            <!-- Dashboard -->
            <section class="section dashboard">
                <div class="breadcrumb">
                    <h1 class="profile_hcolor">Dashboard</h1>
                </div>
                <button class="download-btn">Download Invoice</button>

                <div class="cards">
                    <div class="card blue">
                        <div class="icon">üõ¢Ô∏è</div>
                        <div class="info">
                            <h2>12</h2>
                            <p>Yearly Cylinders</p>
                        </div>
                    </div>

                    <div class="card yellow">
                        <div class="icon">
                            <img src="../../src/images/credit-card.png" alt="Card Icon" />
                        </div>
                        <div class="info">
                            <h2 id="total-payment">2834 Rs</h2>
                            <p>Total Payment</p>
                        </div>
                    </div>

                    <div class="card red">
                        <div class="icon"><img src="../../src/images/question-mark.png" alt="Card Icon" /></div>
                        <div class="info">
                            <h2 id="total-bookings-count">2</h2>
                            <p>Total Booking</p>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Personal Information -->
            <section class="section user-profile" style="display: none;">
                <h1 class="profile_hcolor">My Profile</h1>
                <div class="profile_card user-card">
                    <img src="../../src/images/profile-user.png" class="profile-pic" />
                    <div class="user-info">
                        <h3 id="full-name" class="profile_hcolor"></h3>
                        <p id="profile-role"></p>
                        <!-- <p><span id="profile-city"></span>, <span id="profile-country"></span></p> -->
                        <p id="user-uid"></p>
                    </div>
                </div>

                <div class="profile_card ">
                    <div class="profile-header">
                        <h3 class="profile_hcolor">Personal Information</h3>
                        <button class="edit-btn" onclick="openModal(); testWrite();">Edit ‚úé</button>
                    </div>
                    <hr>
                    <div class="info-grid">
                        <div><strong>Name</strong>
                            <p id="first-name"></p>
                        </div>
                        <!-- <div><strong>Last Name</strong>
                            <p id="last-name"></p>
                        </div> -->
                        <div><strong>Date of Birth</strong>
                            <p id="dob"></p>
                        </div>
                        <div><strong>Email Address</strong>
                            <p id="email"></p>
                        </div>
                        <div><strong>Phone Number</strong>
                            <p id="phone"></p>
                        </div>
                        <div><strong>Role</strong>
                            <!-- replace <p id="role"></p> the below line to fetch it from the database -->
                            <p>Customer</p>
                        </div>
                    </div>
                </div>

                <div class="profile_card ">
                    <div class="profile-header">
                        <h3 class="profile_hcolor">Address</h3>
                        <button class="edit-btn" onclick="openAddressModal(); testWrite();">Edit ‚úé</button>
                    </div>
                    <hr>
                    <div class="info-grid">
                        <div><strong>Country</strong>
                            <p id="country"></p>
                        </div>
                        <div><strong>City</strong>
                            <p id="city"></p>
                        </div>
                        <div><strong>Postal Code</strong>
                            <p id="postal"></p>
                        </div>
                    </div>
                </div>

                <!-- Modal -->
                <div class="modal-overlay" id="editModal1">
                    <div class="modal">
                        <button class="close-btn" onclick="closeModal()">√ó</button>
                        <h2>Edit Personal Information</h2>
                        <form>
                            <div class="row">
                                <div>
                                    <label>Name</label>
                                    <input type="text" id="edit-name" placeholder="Full Name">
                                </div>
                                <!-- <div>
                                    <label>Last Name</label>
                                    <input defaultValue={userData?.LastName} />
                                </div> -->
                            </div>

                            <div class="form-layout">
                                <label>Email Address</label>
                                <input type="email" id="edit-email" placeholder="Email">
                            </div>

                            <div class="form-layout">
                                <label>Phone Number</label>
                                <input type="text" id="edit-phone" placeholder="Phone">
                            </div>

                            <div class="form-layout">
                                <label>Date of Birth</label>
                                <input type="text" id="edit-dob" placeholder="DD/MM/YYYY">
                            </div>

                            <div class="form-layout">
                                <label>User Role</label>
                                <select disabled>
                                    <option>Customer</option>
                                </select>
                            </div>

                            <div class="modal-actions">
                                <button class="save-btn" onclick="saveProfileChanges()">Save
                                    Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- Modal2 -->
                <div class="modal-overlay" id="addressModal">
                    <div class="modal">
                        <button class="close-btn" onclick="closeAddressModal()">√ó</button>
                        <h2>Edit Address</h2>
                        <form>
                            <div class="form-layout">
                                <label>Country</label>
                                <input type="text" id="edit-country" placeholder="Your Country">
                            </div>
                            <div class="form-layout">
                                <label>City</label>
                                <input type="text" id="edit-city" placeholder="Your City">
                            </div>
                            <div class="form-layout">
                                <label>Postal Code</label>
                                <input type="text" id="edit-postal" placeholder="Postal code">
                            </div>
                            <div class="modal-actions">
                                <button class="save-btn" onclick="saveProfileChanges()">Save
                                    Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
            <!-- Book cylinder -->
            <section class="section book-cylinder" style="display: none;">
                <h1 class="profile_hcolor">Book a Cylinder</h1>
                <div class="card booking-card">
                    <div class="icon">üõ¢Ô∏è</div>
                    <div class="info">
                        <h2>Quick Booking</h2>
                        <p>Confirm your booking by clicking below.</p>
                        <button class="book-btn" onclick="bookCylinder()">Proceed</button>
                    </div>
                </div>
            </section>
            <!-- Booking History -->
            <section class="section booking-history" style="display: none;">
                <div class="voucher-header">
                    <div class="breadcrumb">Booking History > <span>View All Bookings</span></div>
                    <!-- <div class="date-refresh">
                        <label>Date Range: </label>
                        <input type="text" id="date-range" value="Mar 16, 2024 - June 15, 2025" readonly />
                        <button class="refresh-btn">Refresh</button>
                    </div> -->
                </div>

                <div class="voucher-container">
                    <h3>VIEW REPORT</h3>

                    <div class="voucher-controls">
                        <label>
                            <select>
                                <option>12</option>
                                <option>24</option>
                                <option>36</option>
                            </select>
                            entries
                        </label>

                        <!-- <label>Search: <input type="search" /></label> -->
                    </div>
                    <div class="voucher-table-container" style="overflow-x: auto;">
                        <table class="voucher-table">
                            <thead>
                                <tr>
                                    <!-- <th>Action</th> -->
                                    <th>Entry No</th>
                                    <th>Ticket No</th>
                                    <th>Booking Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                    <div class="voucher-footer">
                        <div>Showing 1 to 4 of 4 entries</div>
                        <div class="pagination">
                            <button disabled>&lt;</button>
                            <button class="active">1</button>
                            <button disabled>&gt;</button>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Settings -->
            <!-- Password Change Section -->
            <section class="section user-setting" style="display: none;">
                <div id="password-change-section" class="password-wrapper">
                    <h2>Change your password</h2>

                    <div class="form-section">
                        <div class="left-form">
                            <label for="new-password">New Password</label>
                            <div class="input-icon">
                                <input type="password" id="new-password" />
                                <!-- <span id="pass-valid" class="check-icon">‚úî</span> -->
                            </div>

                            <label for="confirm-password">Confirm New Password</label>
                            <div class="input-icon">
                                <input type="password" id="confirm-password" />
                                <!-- <span id="confirm-valid" class="check-icon">‚úî</span> -->
                            </div>
                            <p id="match-msg" class="match-text">Passwords match</p>

                            <button id="change-btn" onclick="showSuccess()">Change my password</button>
                        </div>

                        <div class="right-rules">
                            <strong>Password Suggestion:</strong>
                            <ul>
                                <li id="rule-uppercase" class="valid">At least 1 upper case letter (A-Z)</li>
                                <li id="rule-number" class="valid">At least 1 number (0-9)</li>
                                <li id="rule-length" class="valid">At least 6 characters</li>
                                <li id="rule-symbol" class="valid">Special characters (!,@,....)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Password Success Section -->
                <div id="password-success-section" class="success-card">
                    <div class="success-check">‚úî</div>
                    <h2>Password updated!</h2>
                    <p>Your password has been changed successfully!<br>
                        Use your new password to <a href="#">login</a>
                    </p>
                </div>
            </section>
        </main>
    </div>
    <!-- <button onclick="testWrite()">Test Write</button> -->



    <script src="../../src/js/user/user-dashboard.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { setDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

        // Your Firebase config
        import { firebaseConfig } from "../../firebase-config.js";


        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "user-login.html";
                return;
            }
            console.log("Current User UID: ", auth.currentUser?.uid);

            const uid = user.uid;
            const docRef = doc(db, "registrations", uid);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists()) {
                console.log("No user document found.");
                return;
            }

            const data = docSnap.data();
            const joinedEl = document.getElementById("joined-date");
            if (data.createdAt?.toDate) {
                const joinedDate = data.createdAt.toDate();
                joinedEl.textContent = `Joined ${joinedDate.toLocaleString('default', { month: 'short', year: 'numeric' })}`;
            } else {
                joinedEl.textContent = "Joined (date unknown)";
            }

            // Populate profile display
            document.getElementById("user-name").textContent = data.name || "";
            // document.getElementById("user-role").textContent = data.role || "";
            document.getElementById("full-name").textContent = data.name || "";
            document.getElementById("profile-role").textContent = data.role || "";
            // document.getElementById("profile-city").textContent = data.city || "";
            // document.getElementById("profile-country").textContent = data.country || "";
            document.getElementById("user-uid").textContent = data.uid || "";

            document.getElementById("first-name").textContent = data.name || "";
            document.getElementById("email").textContent = data.email || "";
            document.getElementById("dob").textContent = data.dob || "";
            document.getElementById("phone").textContent = data.phone || "";
            // document.getElementById("role").textContent = data.role || "";
            document.getElementById("country").textContent = data.country || "";
            document.getElementById("city").textContent = data.city || "";
            document.getElementById("postal").textContent = data.postal || "";

            // Populate edit form inputs
            document.getElementById("edit-name").value = data.name || "";
            document.getElementById("edit-email").value = data.email || "";
            document.getElementById("edit-phone").value = data.phone || "";
            document.getElementById("edit-dob").value = data.dob || "";
            document.getElementById("edit-country").value = data.country || "";
            document.getElementById("edit-city").value = data.city || "";
            document.getElementById("edit-postal").value = data.postal || "";

            // calling this function to load table in booking history 
            loadBookingHistory();
        });

        //Save profile changes
        window.saveProfileChanges = async function () {

            console.log("Save button triggered");

            // const user = auth.currentUser;
            if (!auth.currentUser) {
                console.error("No authenticated user.");
                return;
            }

            console.log("auth.currentUser:", auth.currentUser);

            const updatedData = {
                name: document.getElementById("edit-name")?.value || "",
                email: document.getElementById("edit-email")?.value || "",
                phone: document.getElementById("edit-phone")?.value || "",
                dob: document.getElementById("edit-dob")?.value || "",
                country: document.getElementById("edit-country")?.value || "",
                city: document.getElementById("edit-city")?.value || "",
                postal: document.getElementById("edit-postal")?.value || "",
            };

            console.log("Updated data:", updatedData);

            const userRef = doc(db, "registrations", auth.currentUser.uid);

            try {
                await setDoc(userRef, updatedData, { merge: true });
                alert("Profile updated successfully.");
            } catch (error) {
                console.error("Error updating profile:", error);
            }
        };
        window.testWrite = async () => {
            if (!auth.currentUser) {
                alert("Not logged in");
                return;
            }

            const userRef = doc(db, "registrations", auth.currentUser.uid);

            try {
                await setDoc(userRef, { test: "write" }, { merge: true });
                // alert("Write success!");
                //closing both the edit modals 
                // closeModal();
                // closeAddressModal();
            } catch (e) {
                alert("Some Problem Occured at Site. Can't Edit Your Information");
                console.error("Error updating profile:", JSON.stringify(error));
            }
        };


        // ===================Initially show password form===================
        document.getElementById("password-change-section").style.display = "block";

        const newPassword = document.getElementById("new-password");
        const confirmPassword = document.getElementById("confirm-password");
        const matchMsg = document.getElementById("match-msg");
        const passwordSuccess = document.getElementById("password-success-section");
        const passwordChange = document.getElementById("password-change-section");

        // When "Change my password" is clicked
        window.showSuccess = async function () {
            if (newPassword.value.length >= 6 && newPassword.value === confirmPassword.value) {
                validatePassword();
                const user = auth.currentUser;

                if (user) {
                    const email = user.email;
                    const currentPassword = prompt("Enter current password to confirm:");
                    const credential = EmailAuthProvider.credential(email, currentPassword);

                    try {
                        await reauthenticateWithCredential(user, credential);
                        await updatePassword(user, newPassword.value);
                        passwordChange.style.display = "none";
                        passwordSuccess.style.display = "block";
                    } catch (error) {
                        alert("Error updating password: " + error.message);
                    }
                } else {
                    alert("No user is currently signed in.");
                }
            } else if (newPassword.value.length < 6) {
                alert("Password length must be at least 6 characters.");
            } else {
                alert("Passwords do not match.");
            }
        }

        // Password Validation and Change
        function validatePassword() {
            const password = newPassword.value;
            const confirm = confirmPassword.value;
            const match = password && confirm && password === confirm;
            matchMsg.textContent = match ? "Passwords match" : "Passwords do not match";
            matchMsg.style.color = match ? "green" : "red";
        }

        newPassword.addEventListener("input", validatePassword);
        confirmPassword.addEventListener("input", validatePassword);

        //----------------logout -----------------
        window.logoutUser = function () {
            signOut(auth)
                .then(() => {
                    window.location.href = "./user-login.html"; // or your login page
                })
                .catch((error) => {
                    console.error("Error signing out:", error);
                    alert("Failed to log out.");
                });
        };

        // ============================== function to book a cylinder  ============================

        import { collection, query, where, getDocs, addDoc, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        window.bookCylinder = async function () {

            const button = event.target;
            button.disabled = true; // Disable button immediately

            const user = auth.currentUser;
            if (!user) {
                alert("You must be logged in.");
                return;
            }

            const userId = user.uid;

            const bookingsRef = collection(db, "bookings");

            // Step 1: Check booking count for the current year
            const currentYear = new Date().getFullYear();
            const bookingsQuery = query(bookingsRef, where("bookID", "==", userId));
            const bookingsSnapshot = await getDocs(bookingsQuery);


            // Filter by year
            const currentYearBookings = bookingsSnapshot.docs.filter(doc => {
                const date = doc.data().bookingDate?.toDate();
                return date && date.getFullYear() === currentYear;
            });

            if (currentYearBookings.length >= 12) {
                alert("Booking limit of 12 cylinders for the year has been reached.");
                return;
            }

            // Generate ticket number (e.g., 20240614-5)
            // Step 2: Get latest ticketNo for today
            const today = new Date().toISOString().slice(0, 10).replace(/-/g, ""); // YYYYMMDD
            const todayQuery = query(bookingsRef, orderBy("ticketNo", "desc"));
            const todaySnapshot = await getDocs(todayQuery);

            let nextIncrement = 1;
            todaySnapshot.forEach(doc => {
                const ticket = doc.data().ticketNo;
                if (ticket && ticket.startsWith(today)) {
                    const parts = ticket.split("-");
                    const number = parseInt(parts[1]);
                    if (!isNaN(number) && number >= nextIncrement) {
                        nextIncrement = number + 1;
                    }
                }
            });

            const ticketNo = `${today}-${nextIncrement}`;

            // Step 3: Create the booking
            try {
                console.log("Booking by", auth.currentUser?.uid);

                await addDoc(bookingsRef, {
                    bookID: userId,
                    ticketNo: ticketNo,
                    bookingDate: Timestamp.now(),
                    status: "Booked",
                    request: ""
                });
                alert(`Booking successful! Your ticket number is ${ticketNo}`);
                loadBookingHistory(); // reload user's table
            } catch (err) {
                console.error("Booking failed:", err);
                alert("Could not complete booking.");
            }
            finally {
                button.disabled = false; // Always re-enable after completion
            }
        };

        // ================== to load booking history in table ==============================
        window.loadBookingHistory = async function () {
            const user = auth.currentUser;
            if (!user) return;

            const bookingsRef = collection(db, "bookings");
            const q = query(bookingsRef, where("bookID", "==", user.uid), orderBy("bookingDate", "desc"));
            const snapshot = await getDocs(q);

            const tbody = document.querySelector(".voucher-table tbody");
            tbody.innerHTML = ""; // clear existing

            const totalBookings = snapshot.docs.length;
            const totalPayment = totalBookings * 806;

            // Update dashboard values
            if (totalBookings <= 12) {
                document.getElementById("total-bookings-count").textContent = totalBookings;
                document.getElementById("total-payment").textContent = totalPayment;
            }
            if (snapshot.empty) {
                // Optional: you can hide table or show "no data" message
                return;
            }

            let index = snapshot.docs.length;
            snapshot.docs.forEach(doc => {

                const data = doc.data();
                const date = data.bookingDate?.toDate();
                const formattedDate = date ? date.toLocaleDateString("en-GB") : "";

                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>VOU${index.toString().padStart(2, "0")}</td>
            <td>${data.ticketNo}</td>
            <td>${formattedDate}</td>
            <td>${data.status}</td>
        `;
                tbody.appendChild(tr);
                index--;
            });

            document.querySelector(".voucher-footer div:first-child").textContent =
                `Showing ${snapshot.docs.length} out of ${snapshot.docs.length} entries`;
        };

        // ================================= sections state change ========================================================
        // function switchSection(sectionId) {
        //     // // Show the desired section
        //     // document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
        //     // document.getElementById(sectionId).style.display = 'block';

        //     // Push state to history
        //     history.pushState({ section: sectionId }, '', `#${sectionId}`);
        // }
        // // ============ to prevent dashboard exit and go back to previous section instead=========
        // window.addEventListener('popstate', function (event) {
        //     if (event.state && event.state.section) {
        //         switchSection(event.state.section);
        //     } else {
        //         // If no valid state, force stay on dashboard
        //         history.pushState({ section: 'default' }, '', '#');
        //     }
        // });
        // window.addEventListener('load', function () {
        //     history.replaceState({ section: 'default' }, '', '#');
        // });


        // Prevent back button
        window.history.pushState(null, "", window.location.href);
        window.addEventListener("popstate", function () {
            window.history.pushState(null, "", window.location.href);
        });


    </script>

</body>

</html>